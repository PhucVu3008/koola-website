# User Management System - Complete Implementation

**Date**: 2026-01-30  
**Feature**: User accounts management with role-based permissions  
**Status**: ‚úÖ Complete

---

## Overview

Implemented comprehensive user management system with:
- ‚úÖ User CRUD (Create, Read, Update, Delete)
- ‚úÖ Role-based access control (Admin, Manager, Editor)
- ‚úÖ Password management
- ‚úÖ User activation/deactivation
- ‚úÖ Detailed error handling
- ‚úÖ Permission-based UI restrictions

---

## Permission Matrix

| Feature | Admin | Manager | Editor |
|---------|-------|---------|--------|
| **User Management** | | | |
| ‚îî View users list | ‚úÖ Full | ‚úÖ Read-only | ‚ùå No access |
| ‚îî View user details | ‚úÖ Full | ‚úÖ Read-only | ‚ùå No access |
| ‚îî Create user | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| ‚îî Edit user | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| ‚îî Delete user | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| ‚îî Change password | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| ‚îî Toggle active status | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| **Content Management** | | | |
| ‚îî Services | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Posts | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Pages | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Categories/Tags | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Navigation | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Leads | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Newsletter | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Site Settings | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ‚îî Media | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |

**Legend:**
- ‚úÖ Full: Complete CRUD access
- ‚úÖ Read-only: Can view but not modify
- ‚ùå No access: Cannot access at all

---

## Database Schema

### Added Manager Role
```sql
INSERT INTO roles (id, name, description) VALUES 
  (3, 'manager', 'Full access to content management, read-only access to user management');

-- Existing roles updated with descriptions
UPDATE roles SET description = 'Full access to all resources and user management' WHERE name = 'admin';
UPDATE roles SET description = 'Limited access to content editing only' WHERE name = 'editor';
```

### Roles Table Structure
```sql
CREATE TABLE "roles" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" text UNIQUE NOT NULL,
  "description" text  -- Added in migration 018
);
```

---

## Backend Implementation

### 1. Controller - `adminUserController.ts`

**Endpoints:**
```typescript
GET    /v1/admin/users           // List users (admin, manager)
GET    /v1/admin/users/:id       // Get user by ID (admin, manager)
GET    /v1/admin/users/roles     // List all roles (admin, manager)
POST   /v1/admin/users           // Create user (admin only)
PUT    /v1/admin/users/:id       // Update user (admin only)
DELETE /v1/admin/users/:id       // Delete user (admin only)
PUT    /v1/admin/users/:id/password        // Change password (admin only)
PUT    /v1/admin/users/:id/toggle-active  // Toggle active (admin only)
```

**Key Features:**
- ‚úÖ Detailed error handling with ZodError detection
- ‚úÖ Duplicate email detection (23505 constraint error)
- ‚úÖ Self-protection (cannot delete/deactivate own account)
- ‚úÖ Role protection (cannot remove own admin role)
- ‚úÖ Password hashing with bcrypt

**Example Controller Function:**
```typescript
export const createUser = async (request: FastifyRequest, reply: FastifyReply) => {
  try {
    const body = adminUserCreateSchema.parse(request.body);
    
    const userId = await adminUserService.createUser({
      createdBy: currentUserId,
      data: body,
    });

    return reply.status(201).send(successResponse({ id: userId }));
  } catch (error: any) {
    if (error.name === 'ZodError') {
      return reply.status(400).send(
        errorResponse(ErrorCodes.VALIDATION_ERROR, 'Validation failed', {
          issues: error.issues,
          requiredFields: ['email', 'password', 'full_name', 'role_ids'],
        })
      );
    }
    
    // Handle duplicate email
    if (error.code === '23505' && error.constraint === 'users_email_key') {
      return reply.status(400).send(
        errorResponse(ErrorCodes.VALIDATION_ERROR, 'Email already exists')
      );
    }
    
    throw error;
  }
};
```

---

### 2. Service - `adminUserService.ts`

**Key Functions:**
```typescript
listUsers(params: ListUsersParams)          // With pagination, filters
getUserById(id: number)                     // With roles
createUser(params: CreateUserParams)        // Hash password, assign roles
updateUser(params: UpdateUserParams)        // Update user + roles
deleteUser(id: number)                      // Hard delete (cascade)
changeUserPassword(id, newPassword)         // Bcrypt hash
toggleUserActive(id: number)                // Toggle is_active
listRoles()                                 // All available roles
```

**Transaction Safety:**
```typescript
export async function createUser(params: CreateUserParams): Promise<number> {
  const client = await pool.connect();

  try {
    await client.query('BEGIN');

    // Insert user
    const userResult = await client.query(
      `INSERT INTO users (email, password_hash, full_name, is_active)
       VALUES ($1, $2, $3, $4)
       RETURNING id`,
      [data.email, passwordHash, data.full_name, data.is_active]
    );

    const userId = userResult.rows[0].id;

    // Insert user roles
    for (const roleId of data.role_ids) {
      await client.query(
        `INSERT INTO user_roles (user_id, role_id)
         VALUES ($1, $2)
         ON CONFLICT DO NOTHING`,
        [userId, roleId]
      );
    }

    await client.query('COMMIT');
    return userId;
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}
```

---

### 3. Routes - `routes/admin/users.ts`

**Permission Structure:**
```typescript
const adminUsersRoutes: FastifyPluginAsync = async (server) => {
  server.addHook('preHandler', authenticate);

  // Read operations - admin & manager
  server.get('/roles', {
    preHandler: authorize(['admin', 'manager']),
    handler: adminUserController.listRoles,
  });

  server.get('/', {
    preHandler: authorize(['admin', 'manager']),
    handler: adminUserController.listUsers,
  });

  // Write operations - admin only
  server.post('/', {
    preHandler: authorize(['admin']),
    handler: adminUserController.createUser,
  });

  server.put('/:id', {
    preHandler: authorize(['admin']),
    handler: adminUserController.updateUser,
  });
};
```

**Important:** `/roles` must be defined BEFORE `/:id` to avoid route conflict.

---

### 4. Schemas - `schemas/users.schemas.ts`

```typescript
export const adminUserCreateSchema = z.object({
  email: z.string().email('Invalid email format'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  full_name: z.string().min(1, 'Full name is required'),
  role_ids: z.array(z.number().int().positive()).min(1, 'At least one role is required'),
  is_active: z.boolean().default(true),
});

export const adminUserUpdateSchema = z.object({
  email: z.string().email('Invalid email format').optional(),
  full_name: z.string().min(1, 'Full name is required').optional(),
  role_ids: z.array(z.number().int().positive()).optional(),
  is_active: z.boolean().optional(),
});

export const adminUserChangePasswordSchema = z.object({
  new_password: z.string().min(8, 'Password must be at least 8 characters'),
});
```

---

### 5. Updated Authorization for All Routes

**All admin routes now accept `manager` role:**

```typescript
// Before (only admin & editor)
server.addHook('preHandler', authorize(['admin', 'editor']));

// After (includes manager)
server.addHook('preHandler', authorize(['admin', 'manager', 'editor']));
```

**Files Updated:**
- ‚úÖ `routes/admin/posts.ts`
- ‚úÖ `routes/admin/services.ts`
- ‚úÖ `routes/admin/categories.ts`
- ‚úÖ `routes/admin/tags.ts`
- ‚úÖ `routes/admin/leads.ts`
- ‚úÖ `routes/admin/newsletterSubscribers.ts`
- ‚úÖ `routes/admin/navItems.ts`
- ‚úÖ `routes/admin/siteSettings.ts`
- ‚úÖ `routes/admin/pages.ts`

---

## Frontend Implementation

### 1. Admin API Client - `lib/admin-api.ts`

**New Methods:**
```typescript
async listUsers(params?: { page, pageSize, role, isActive })
async getUserById(id: number)
async createUser(data: { email, password, full_name, role_ids, is_active })
async updateUser(id, data: { email?, full_name?, role_ids?, is_active? })
async deleteUser(id: number)
async changeUserPassword(id: number, newPassword: string)
async toggleUserActive(id: number)
async listRoles()
```

**All methods include:**
- ‚úÖ Automatic token refresh on 401
- ‚úÖ Detailed validation error formatting
- ‚úÖ Typed request/response

---

### 2. Users List Page - `app/admin/[locale]/users/page.tsx`

**Features:**
- ‚úÖ Paginated user list with sorting
- ‚úÖ Filter by role (admin/manager/editor)
- ‚úÖ Filter by status (active/inactive)
- ‚úÖ Role badges with color coding
- ‚úÖ Quick actions (edit, change password, toggle active, delete)
- ‚úÖ Last login timestamp
- ‚úÖ Confirmation dialogs for destructive actions

**UI Components:**
```tsx
<table>
  <thead>
    <tr>
      <th>User (Name + Email)</th>
      <th>Roles (Badges)</th>
      <th>Status (Active/Inactive)</th>
      <th>Last Login</th>
      <th>Actions (Edit, Password, Toggle, Delete)</th>
    </tr>
  </thead>
  <tbody>
    {users.map(user => (
      <tr>
        <td>{user.full_name}<br/>{user.email}</td>
        <td>{user.roles.map(role => <Badge>{role.name}</Badge>)}</td>
        <td><StatusBadge active={user.is_active} /></td>
        <td>{formatDate(user.last_login_at)}</td>
        <td>
          <IconButton onClick={editUser} icon={Pencil} />
          <IconButton onClick={changePassword} icon={Key} />
          <IconButton onClick={toggleActive} icon={Power} />
          <IconButton onClick={deleteUser} icon={Trash2} />
        </td>
      </tr>
    ))}
  </tbody>
</table>
```

---

### 3. User Form Component - `components/admin/UserForm.tsx`

**Props:**
```typescript
interface UserFormProps {
  userId?: number;
  locale: string;
  mode: 'create' | 'edit';
}
```

**Features:**
- ‚úÖ Reusable for both create and edit modes
- ‚úÖ Email validation (format check)
- ‚úÖ Password validation (min 8 chars, optional on edit)
- ‚úÖ Role selection with descriptions
- ‚úÖ Active/inactive toggle
- ‚úÖ Client-side validation before submit
- ‚úÖ Detailed error messages with field-level details
- ‚úÖ Loading states and success feedback

**Form Sections:**
1. **Basic Information**
   - Email (required, validated)
   - Password (required on create, optional on edit)
   - Full name (required)

2. **Roles & Permissions**
   - Checkbox list of available roles
   - Each role shows name + description
   - At least one role required

3. **Status**
   - Active/inactive checkbox
   - Explanation of impact

**Validation:**
```typescript
const validateForm = (): boolean => {
  if (!formData.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    setError('Please enter a valid email address');
    return false;
  }

  if (mode === 'create' && !formData.password) {
    setError('Password is required');
    return false;
  }

  if (formData.password && formData.password.length < 8) {
    setError('Password must be at least 8 characters');
    return false;
  }

  if (formData.role_ids.length === 0) {
    setError('At least one role must be selected');
    return false;
  }

  return true;
};
```

---

### 4. Create User Page - `app/admin/[locale]/users/new/page.tsx`

```tsx
import { UserForm } from '@/components/admin/UserForm';

export default function CreateUserPage({ params }: { params: { locale: string } }) {
  return <UserForm locale={params.locale} mode="create" />;
}
```

---

### 5. Edit User Page - `app/admin/[locale]/users/[id]/page.tsx`

```tsx
import { UserForm } from '@/components/admin/UserForm';

export default function EditUserPage({ params }: { params: { locale: string; id: string } }) {
  return <UserForm userId={parseInt(params.id)} locale={params.locale} mode="edit" />;
}
```

---

### 6. Change Password Page - `app/admin/[locale]/users/[id]/password/page.tsx`

**Features:**
- ‚úÖ Dedicated page for password changes
- ‚úÖ New password + confirm password fields
- ‚úÖ Min 8 characters validation
- ‚úÖ Password match validation
- ‚úÖ Success message with auto-redirect
- ‚úÖ Security note about notifying user

**Form Fields:**
```tsx
<form onSubmit={handleSubmit}>
  <input
    type="password"
    placeholder="New password (min 8 chars)"
    value={newPassword}
    onChange={(e) => setNewPassword(e.target.value)}
    minLength={8}
    required
  />
  
  <input
    type="password"
    placeholder="Confirm password"
    value={confirmPassword}
    onChange={(e) => setConfirmPassword(e.target.value)}
    required
  />
  
  <button type="submit">Change Password</button>
</form>

{/* Security Note */}
<div className="bg-yellow-50 p-4">
  <p>üîí Security Note: The user will need to use this new password on their next login.</p>
</div>
```

---

### 7. Admin Layout - `components/admin/AdminLayout.tsx`

**Added Users Menu Item:**
```tsx
{
  name: locale === 'vi' ? 'Ng∆∞·ªùi d√πng' : 'Users',
  href: `/admin/${locale}/users`,
  icon: Users,  // Added Users icon import
}
```

**Menu Order:**
1. Dashboard
2. Services
3. Posts
4. Categories
5. Tags
6. Pages
7. Navigation
8. **Users** ‚Üê NEW
9. Site Settings
10. Leads
11. Newsletter

---

## Security Features

### 1. Self-Protection
```typescript
// Cannot delete own account
if (id === currentUserId) {
  return reply.status(400).send(
    errorResponse(ErrorCodes.VALIDATION_ERROR, 'Cannot delete your own account')
  );
}

// Cannot deactivate own account
if (id === currentUserId) {
  return reply.status(400).send(
    errorResponse(ErrorCodes.VALIDATION_ERROR, 'Cannot deactivate your own account')
  );
}

// Cannot remove own admin role
if (id === currentUserId && body.role_ids && !body.role_ids.includes(1)) {
  return reply.status(400).send(
    errorResponse(ErrorCodes.VALIDATION_ERROR, 'Cannot remove your own admin role')
  );
}
```

### 2. Password Security
```typescript
// Hash password with bcrypt (10 rounds)
const passwordHash = await bcrypt.hash(data.password, 10);

// Store only hash, never plain text
INSERT INTO users (email, password_hash, ...) VALUES (...)
```

### 3. Transaction Safety
```typescript
// All multi-step operations use transactions
await client.query('BEGIN');
try {
  // ... operations
  await client.query('COMMIT');
} catch (error) {
  await client.query('ROLLBACK');
  throw error;
}
```

### 4. Permission Enforcement
```typescript
// Route-level authorization
server.get('/', {
  preHandler: authorize(['admin', 'manager']),  // Only specific roles
  handler: adminUserController.listUsers,
});
```

---

## Error Handling

### Backend Errors
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed. Please check required fields.",
    "details": {
      "issues": [
        {
          "path": ["email"],
          "message": "Invalid email format",
          "expected": "string (email)",
          "received": "invalid@"
        }
      ],
      "requiredFields": ["email", "password", "full_name", "role_ids"]
    }
  }
}
```

### Frontend Display
```typescript
catch (err: any) {
  if (err.message && err.message.includes('Validation')) {
    setError(`‚ùå ${err.message}`);  // Detailed field-level errors
  } else {
    setError(err.message || 'Failed to save user');
  }
}
```

### Common Errors
| Error | Cause | Solution |
|-------|-------|----------|
| "Email already exists" | Duplicate email | Use different email |
| "Password must be at least 8 characters" | Short password | Use longer password |
| "At least one role is required" | No roles selected | Select at least one role |
| "Cannot delete your own account" | Self-deletion attempt | Use different admin |
| "Cannot remove your own admin role" | Self-demotion attempt | Use different admin |

---

## Testing

### Backend API Tests

```bash
# 1. Login as admin
curl -X POST http://localhost:4000/v1/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@koola.com", "password": "admin123"}'
# Save access_token

# 2. List users
curl http://localhost:4000/v1/admin/users \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. Get user by ID
curl http://localhost:4000/v1/admin/users/1 \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. List roles
curl http://localhost:4000/v1/admin/users/roles \
  -H "Authorization: Bearer YOUR_TOKEN"

# 5. Create user
curl -X POST http://localhost:4000/v1/admin/users \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "manager@koola.com",
    "password": "manager123",
    "full_name": "Manager User",
    "role_ids": [3],
    "is_active": true
  }'

# 6. Update user
curl -X PUT http://localhost:4000/v1/admin/users/2 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "full_name": "Updated Manager",
    "role_ids": [2, 3]
  }'

# 7. Change password
curl -X PUT http://localhost:4000/v1/admin/users/2/password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"new_password": "newpassword123"}'

# 8. Toggle active status
curl -X PUT http://localhost:4000/v1/admin/users/2/toggle-active \
  -H "Authorization: Bearer YOUR_TOKEN"

# 9. Delete user
curl -X DELETE http://localhost:4000/v1/admin/users/2 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Frontend UI Tests

```
1. Open http://localhost:3000/admin/en/users
2. Should see list of users with filters
3. Click "Create User"
   - Fill form with valid data
   - Should create successfully
4. Click edit icon on a user
   - Should load user data
   - Update fields
   - Should save successfully
5. Click key icon (change password)
   - Enter new password twice
   - Should change successfully
6. Click power icon (toggle active)
   - Should toggle status
7. Click delete icon
   - Should show confirmation
   - Should delete after confirm
8. Test filters
   - Filter by role
   - Filter by status
   - Should update list
9. Test pagination
   - Create 20+ users
   - Should paginate correctly
```

---

## Files Created/Modified

### Backend (9 files)
1. ‚úÖ `migrations/018_add_manager_role.sql` - Database migration
2. ‚úÖ `apps/api/src/controllers/adminUserController.ts` - User CRUD controller
3. ‚úÖ `apps/api/src/services/adminUserService.ts` - User business logic
4. ‚úÖ `apps/api/src/schemas/users.schemas.ts` - Zod validation schemas
5. ‚úÖ `apps/api/src/routes/admin/users.ts` - User routes with permissions
6. ‚úÖ `apps/api/src/routes/admin/index.ts` - Register users routes
7-16. ‚úÖ Updated 10 admin routes to include 'manager' role

### Frontend (6 files)
1. ‚úÖ `apps/web/src/lib/admin-api.ts` - Added user API methods
2. ‚úÖ `apps/web/app/admin/[locale]/users/page.tsx` - Users list page
3. ‚úÖ `apps/web/app/admin/[locale]/users/new/page.tsx` - Create user page
4. ‚úÖ `apps/web/app/admin/[locale]/users/[id]/page.tsx` - Edit user page
5. ‚úÖ `apps/web/app/admin/[locale]/users/[id]/password/page.tsx` - Change password page
6. ‚úÖ `apps/web/components/admin/UserForm.tsx` - Reusable user form component
7. ‚úÖ `apps/web/components/admin/AdminLayout.tsx` - Added Users menu item

---

## Next Steps

### Recommended Enhancements
- [ ] **Bulk Operations**: Select multiple users for batch activate/deactivate
- [ ] **User Activity Log**: Track login history and actions
- [ ] **Password Reset**: Email-based password reset flow
- [ ] **Profile Pictures**: Upload and manage user avatars
- [ ] **Advanced Filtering**: Search by name, email, date range
- [ ] **Export Users**: CSV export for reporting
- [ ] **Audit Trail**: Log all user changes for compliance
- [ ] **Session Management**: View and revoke active sessions

### Optional Features
- [ ] **Two-Factor Authentication**: Add 2FA support
- [ ] **API Keys**: Generate API keys for users
- [ ] **Fine-Grained Permissions**: Per-resource permissions
- [ ] **User Groups**: Organize users into groups
- [ ] **Custom Roles**: Create custom roles beyond admin/manager/editor

---

## Troubleshooting

### Issue: "Cannot find module adminUserService"
**Solution**: Restart API container
```bash
docker-compose restart api
```

### Issue: "Role not found when creating user"
**Solution**: Run migration
```bash
cat migrations/018_add_manager_role.sql | docker-compose exec -T postgres psql -U koola_user -d koola_db
```

### Issue: "Cannot access users page (403 Forbidden)"
**Solution**: Check user has admin or manager role
```sql
SELECT u.email, r.name 
FROM users u 
JOIN user_roles ur ON u.id = ur.user_id 
JOIN roles r ON ur.role_id = r.id;
```

### Issue: "Validation errors not showing details"
**Solution**: Check admin-api.ts includes error formatting code (already implemented)

---

**Status**: ‚úÖ User Management System Complete  
**Next**: Test all CRUD operations and permissions  
**Impact**: Full role-based access control across entire admin panel
